<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghi Ch√∫ Th·ªùi Gian Th·ª±c</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        #input-pass {
            width: 300px;
            /* ƒê·∫∑t chi·ªÅu r·ªông nh·ªè h∆°n */
            margin: 100px auto;
            /* CƒÉn gi·ªØa theo chi·ªÅu ngang v√† c√°ch tr√™n 100px */
            text-align: center;
            /* CƒÉn gi·ªØa n·ªôi dung b√™n trong */
        }

        #input-pass .form-label {
            font-size: 14px;
            /* Gi·∫£m k√≠ch th∆∞·ªõc ch·ªØ */
        }

        #input-pass input {
            font-size: 14px;
            /* Gi·∫£m k√≠ch th∆∞·ªõc input */
            padding: 6px;
        }

        #input-pass button {
            font-size: 14px;
            /* Gi·∫£m k√≠ch th∆∞·ªõc n√∫t */
            padding: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        img {
            max-width: 100px;
            height: auto;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container mt-4">
        <h3 id="status"></h3>
        <h2 class="text-center mb-4">üìå Ghi ch√∫ th·ªùi gian th·ª±c</h2>

        <h2>Danh s√°ch ghi ch√∫</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ti√™u ƒë·ªÅ</th>
                    <th>N·ªôi dung</th>
                    <th>Danh m·ª•c</th>
                    <th>Th·∫ª</th>
                    <th>·∫¢nh</th>
                    <th>Ng√†y t·∫°o</th>
                    <th>Ghim</th>
                </tr>
            </thead>
            <tbody id="notesTableBody">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </tbody>
        </table>

        <div class="mb-3">
            <input type="text" id="searchs" placeholder="T√¨m ki·∫øm ghi ch√∫..." class="form-control">
            <div id="results"></div>
        </div>
        <div class="card p-4 shadow" id="input-pass">

            <div class="mb-3">
                <label for="password" class="form-label">üîë Nh·∫≠p Password:</label>
                <input type="text" id="password" class="form-control">
            </div>
            <button class="btn btn-primary w-100" onclick="fetchNote()">üîç Xem Ghi Ch√∫</button>

            <button class="btn btn-success w-100 mt-5" onclick="fetchNotePerson()">üîç Xem Ghi Ch√∫ C√° nh√¢n</button>

        </div>

        <input type="hidden" id="note-id">

        <div id="notes-container" class="mt-4" style="display: none;">
            <div class="row">
                <div class="col-12 col-md-4">
                    <div class="card p-4 shadow">
                        <h3 id="note-title">üìù Ghi ch√∫: Kh√¥ng c√≥ ti√™u ƒë·ªÅ</h3>
                        <p id="note-edit"></p>
                        <p><strong>üìÇ Th·ªÉ lo·∫°i:</strong> <span id="note-category">Kh√¥ng c√≥</span></p>
                        <p><strong>üè∑Ô∏è Tags:</strong> <span id="note-tags">Kh√¥ng c√≥</span></p>
                        <p><strong>üìÖ Ng√†y t·∫°o:</strong> <span id="note-created">Kh√¥ng r√µ</span></p>
                    </div>
                </div>
                <div class="col-6 col-md-8">
                    <div class="card p-4 shadow">
                        <div class="mt-3">
                            <button id="edit-button" class="btn btn-warning" onclick="toggleEdit()">‚úèÔ∏è Ch·ªânh
                                s·ª≠a</button>
                            <button id="save-button" class="btn btn-success" onclick="saveEdit()"
                                style="display: none;">üíæ
                                L∆∞u</button>
                        </div>
                        <textarea id="note-content" class="form-control mt-2" rows="4"
                            readonly>Ch∆∞a c√≥ n·ªôi dung</textarea>
                        <h1>·∫¢nh ƒë√≠nh k√®m</h1>
                        <div id="image-container" class="row mt-3"></div> <!-- Ch·ªó ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io('http://localhost:3000');
        let isEditing = false;

        function fetchNote() {
            const noteId = document.getElementById('note-id').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!noteId) {
                alert("Vui l√≤ng nh·∫≠p Note ID!");
                return;
            }

            socket.emit('request_note', { noteId, password });

        }

        function fetchNotePerson() {
            const noteId = document.getElementById('note-id').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!noteId) {
                alert("Vui l√≤ng nh·∫≠p Note ID!");
                return;
            }


            socket.emit('request_note_person', { noteId, password });
        }




        socket.on('load_note', (noteData) => {
            console.log("üìú D·ªØ li·ªáu ghi ch√∫ nh·∫≠n ƒë∆∞·ª£c:", noteData);

            if (!noteData || typeof noteData !== 'object') {
                document.getElementById('note-content').value = "L·ªói d·ªØ li·ªáu!";
                return;
            }

            if (noteData.permission == 'edit') {
                document.getElementById('note-edit').innerHTML = "‚úèÔ∏è<strong>ƒê∆∞·ª£c ph√©p edit</strong>";
            } else if (noteData.permission == 'read') {
                document.getElementById('note-edit').innerHTML = "üëÅÔ∏è <strong>Ch·ªâ ƒë∆∞·ª£c ph√©p ƒë·ªçc</strong>";
                document.getElementById("edit-button").style.visibility = "hidden";
            } else if (noteData.permission == '') {
                document.getElementById('note-edit').innerHTML = "‚úèÔ∏è<strong>ƒê∆∞·ª£c ph√©p edit</strong>";
            }

            if (noteData && noteData.message) {
                const mess = noteData.message.trim();
                alert(mess);

                if (noteData.error || mess === "M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng ho·∫∑c ghi ch√∫ kh√¥ng t·ªìn t·∫°i.jhjj") {
                    document.getElementById('input-pass').style.display = "block";
                    document.getElementById('notes-container').style.display = "none";

                } else {
                    document.getElementById('notes-container').style.display = "block";
                    document.getElementById('input-pass').style.display = "none";
                }
            }


            document.getElementById("note-title").style.color = noteData.note_color;
            document.getElementById("note-title").style.fontSize = noteData.font_size; // Thay ƒë·ªïi m√†u ch·ªØ th√†nh ƒë·ªè
            document.getElementById('note-title').innerText = `üìù Ghi ch√∫: ${noteData.title || "Kh√¥ng c√≥ ti√™u ƒë·ªÅ"}`;
            document.getElementById('note-content').value = noteData.content || "Kh√¥ng c√≥ n·ªôi dung";
            document.getElementById('note-category').innerText = noteData.category || "Kh√¥ng c√≥";
            document.getElementById('note-tags').innerText = noteData.tags || "Kh√¥ng c√≥";
            document.getElementById('note-created').innerText = noteData.created_at || "Kh√¥ng r√µ";

            const imageContainer = document.getElementById("image-container");
            imageContainer.innerHTML = ""; // X√≥a ·∫£nh c≈© tr∆∞·ªõc khi hi·ªÉn th·ªã ·∫£nh m·ªõi

            try {
                let images = noteData.image;
                if (typeof images === 'string') {
                    images = JSON.parse(images);
                }

                console.log("üì∏ Danh s√°ch ·∫£nh:", images);

                if (Array.isArray(images) && images.length > 0) {
                    images.forEach(imgSrc => {
                        if (imgSrc) {
                            const imgElement = document.createElement("img");
                            imgElement.src = `http://localhost/note_management/api/${imgSrc}`;
                            imgElement.classList.add("img-fluid", "rounded", "shadow-sm");
                            imgElement.style.width = "100%";
                            imgElement.style.marginBottom = "10px";

                            const col = document.createElement("div");
                            col.classList.add("col-md-3");
                            col.appendChild(imgElement);
                            imageContainer.appendChild(col);
                        }
                    });
                } else {
                    imageContainer.innerHTML = "<p class='text-muted'>Kh√¥ng c√≥ ·∫£nh</p>";
                }
            } catch (error) {
                console.error("‚ùå L·ªói khi x·ª≠ l√Ω ·∫£nh:", error);
                imageContainer.innerHTML = "<p class='text-danger'>L·ªói khi t·∫£i ·∫£nh</p>";
            }
        });

        function toggleEdit() {
            const textArea = document.getElementById('note-content');
            const editButton = document.getElementById('edit-button');
            const saveButton = document.getElementById('save-button');

            if (!isEditing) {
                textArea.removeAttribute('readonly');
                textArea.focus();
                editButton.style.display = 'none';
                saveButton.style.display = 'inline-block';
                isEditing = true;
            }
        }

        function saveEdit() {
            const noteId = document.getElementById('note-id').value.trim();
            const password = document.getElementById('password').value.trim();
            const content = document.getElementById('note-content').value.trim();

            if (!noteId || !password) {
                alert("Thi·∫øu th√¥ng tin ƒë·ªÉ l∆∞u!");
                return;
            }

            socket.emit('edit_note', { noteId, password, content });

            document.getElementById('note-content').setAttribute('readonly', true);
            document.getElementById('edit-button').style.display = 'inline-block';
            document.getElementById('save-button').style.display = 'none';
            isEditing = false;
        }

        socket.on('note_updated', (data) => {
            if (data.noteId === document.getElementById('note-id').value.trim()) {
                document.getElementById('note-content').value = data.content;
            }
        });

        const params = new URLSearchParams(window.location.search);
        const note_id = params.get("note_id");

        if (note_id) {
            document.getElementById("note-id").value = note_id;
        }
    </script>
    <script>
        function checkSession() {
            fetch('http://localhost/note_management/api/check_session.php')
                .then(response => response.json())
                .then(data => {
                    if (data.logged_in) {
                        console.log("‚úÖ ƒê√£ ƒëƒÉng nh·∫≠p! User ID:", data.user_id);
                        document.getElementById("status").innerText = "B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p!";
                    } else {
                        console.log("‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p!");
                        document.getElementById("status").innerText = "B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!";
                        // window.location.href = "https://google.com/"; // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang login
                    }
                })
                .catch(error => console.error("L·ªói khi ki·ªÉm tra session:", error));
        }

        // G·ªçi function khi trang load
        window.onload = checkSession;

    </script>
    <script>
        let timeout = null;

        document.getElementById('searchs').addEventListener('input', function () {
            clearTimeout(timeout);
            const keyword = this.value;

            // ƒê·∫∑t ƒë·ªô tr·ªÖ 300ms tr∆∞·ªõc khi th·ª±c hi·ªán t√¨m ki·∫øm
            timeout = setTimeout(() => {
                if (keyword.length > 0) {
                    fetch(`http://localhost/note_management/api/search_note.php?keyword=${encodeURIComponent(keyword)}`)
                        .then(response => response.json())
                        .then(data => {
                            const resultsDiv = document.getElementById('results');
                            resultsDiv.innerHTML = ''; // X√≥a k·∫øt qu·∫£ tr∆∞·ªõc ƒë√≥

                            if (Array.isArray(data) && data.length > 0) {
                                let rowDiv = document.createElement('div');
                                rowDiv.classList.add('row', 'g-3'); // Bootstrap Grid System

                                // M·∫£ng m√†u Bootstrap badge
                                const badgeColors = [
                                    "primary", "secondary", "success", "danger",
                                    "warning", "info", "dark"
                                ];

                                data.forEach(note => {
                                    const colDiv = document.createElement('div');
                                    colDiv.classList.add('col-md-4'); // M·ªói ghi ch√∫ chi·∫øm 4 c·ªôt tr√™n m√†n h√¨nh trung b√¨nh tr·ªü l√™n

                                    // Chuy·ªÉn `tags` t·ª´ chu·ªói ho·∫∑c m·∫£ng JSON th√†nh m·∫£ng
                                    let tagsArray = Array.isArray(note.tags) ? note.tags : note.tags.split(',');

                                    // T·∫°o badge v·ªõi m√†u s·∫Øc ng·∫´u nhi√™n
                                    const tagsHTML = tagsArray.map(tag => {
                                        let randomColor = badgeColors[Math.floor(Math.random() * badgeColors.length)];
                                        return `<span class="badge bg-${randomColor} me-1">${tag.trim()}</span>`;
                                    }).join(' ');

                                    colDiv.innerHTML = `
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">${note.title}</h5>
                                        <p class="card-text">${note.content}</p>
                                    </div>
                                    <div class="card-footer text-muted">
                                        ${tagsHTML}
                                    </div>
                                </div>
                            `;

                                    rowDiv.appendChild(colDiv);
                                });

                                resultsDiv.appendChild(rowDiv);
                            } else {
                                resultsDiv.innerHTML = '<p class="text-danger">Kh√¥ng t√¨m th·∫•y ghi ch√∫ n√†o.</p>';
                            }
                        })
                        .catch(error => console.error('L·ªói:', error));
                } else {
                    document.getElementById('results').innerHTML = ''; // X√≥a k·∫øt qu·∫£ n·∫øu kh√¥ng c√≥ t·ª´ kh√≥a
                }
            }, 300);
        });
    </script>

    <script>
        async function fetchNotes() {
            try {
                const response = await fetch('http://localhost/note_management/api/get_notes.php'); // G·ªçi API PHP
                if (!response.ok) {
                    throw new Error('L·ªói m·∫°ng ho·∫∑c m√°y ch·ªß');
                }
                const notes = await response.json();

                // L·∫•y ph·∫ßn tbody c·ªßa b·∫£ng
                const tableBody = document.getElementById('notesTableBody');
                tableBody.innerHTML = ""; // X√≥a n·ªôi dung c≈©

                // Duy·ªát qua danh s√°ch ghi ch√∫ v√† th√™m v√†o b·∫£ng
                notes.forEach(note => {
                    const row = document.createElement('tr');
                    // row.style.backgroundColor = note.note_color || '#ffffff'; // √Åp d·ª•ng m√†u n·ªÅn

                    row.innerHTML = `
                    <td>${note.id}</td>
                    <td style="font-size: ${note.font_size}">${note.title}</td>
                    <td>${note.content}</td>
                    <td>${note.category}</td>
                    <td>${note.tags}</td>
                    <td>
                        ${note.image ? note.image.map(img => `<img src="http://localhost/note_management/api/${img}" alt="·∫¢nh">`).join(' ') : 'Kh√¥ng c√≥ ·∫£nh'}
                    </td>
                    <td>${note.created_at}</td>
                    <td>${note.is_pinned ? 'üìå' : ''}</td>
                `;

                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('L·ªói:', error);
            }
        }

        // G·ªçi h√†m ƒë·ªÉ t·∫£i d·ªØ li·ªáu khi trang t·∫£i xong
        document.addEventListener('DOMContentLoaded', fetchNotes);
    </script>
</body>

</html>