<?php
require 'config.php'; // K·∫øt n·ªëi t·ªõi c∆° s·ªü d·ªØ li·ªáu
session_start();


// üî• Th√™m header ƒë·ªÉ b·∫≠t CORS
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: GET, POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type");

// Tr·∫£ v·ªÅ JSON
header('Content-Type: application/json');


// Ki·ªÉm tra ƒëƒÉng nh·∫≠p
// if (!isset($_SESSION['user_id'])) {
//     http_response_code(401);
//     echo json_encode(['message' => 'Ch∆∞a ƒëƒÉng nh·∫≠p.']);
//     exit;
// }


$key = "12345";

function decodeNumber($encoded, $key) {
    $encoded = str_replace(['-', '_'], ['+', '/'], $encoded); // Chuy·ªÉn ƒë·ªïi v·ªÅ base64 th√¥ng th∆∞·ªùng
    $decoded = base64_decode($encoded);
    if ($decoded === false) return false;

    list($number, $hash) = explode('::', $decoded);
    $validHash = hash_hmac('sha256', $number, $key, true);

    return hash_equals($validHash, $hash) ? $number : false;
}


try {
    // **X·ª≠ l√Ω t·∫°o ghi ch√∫ m·ªõi (POST)**
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $title = isset($_POST['title']) ? trim($_POST['title']) : '';
        $content = isset($_POST['content']) ? trim($_POST['content']) : '';
        $is_pinned = isset($_POST['is_pinned']) ? (int)$_POST['is_pinned'] : 0;
        $category = isset($_POST['category']) ? trim($_POST['category']) : null;

        // Nh·∫≠n tags d∆∞·ªõi d·∫°ng chu·ªói v√† chuy·ªÉn ƒë·ªïi th√†nh m·∫£ng
        $tags = isset($_POST['tags']) ? trim($_POST['tags']) : '';
        $tagsArray = !empty($tags) ? explode(',', $tags) : [];

        $password = isset($_POST['password']) ? trim($_POST['password']) : null;

        $imagePaths = []; // M·∫£ng ƒë·ªÉ l∆∞u ƒë∆∞·ªùng d·∫´n ·∫£nh

        // Ki·ªÉm tra t·ªáp ·∫£nh
        if (isset($_FILES['images']) && is_array($_FILES['images']['name'])) {
            $target_dir = "uploads/";

            // Ki·ªÉm tra xem th∆∞ m·ª•c uploads c√≥ t·ªìn t·∫°i kh√¥ng, n·∫øu kh√¥ng th√¨ t·∫°o
            if (!is_dir($target_dir)) {
                if (!mkdir($target_dir, 0777, true)) {
                    echo json_encode(['message' => 'Kh√¥ng th·ªÉ t·∫°o th∆∞ m·ª•c uploads.']);
                    exit;
                }
            }

            foreach ($_FILES['images']['name'] as $key => $name) {
                if ($_FILES['images']['error'][$key] === UPLOAD_ERR_OK) {
                    $target_file = $target_dir . basename($name);
                    $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));

                    // Ki·ªÉm tra ƒë·ªãnh d·∫°ng ·∫£nh
                    $allowed_types = ['jpg', 'png', 'jpeg', 'gif'];
                    if (!in_array($imageFileType, $allowed_types)) {
                        echo json_encode(['message' => 'Ch·ªâ cho ph√©p t·∫£i l√™n c√°c ƒë·ªãnh d·∫°ng JPG, JPEG, PNG, GIF.']);
                        exit;
                    }

                    // T·∫£i ·∫£nh l√™n
                    if (move_uploaded_file($_FILES['images']['tmp_name'][$key], $target_file)) {
                        $imagePaths[] = $target_file; // L∆∞u ƒë∆∞·ªùng d·∫´n ·∫£nh
                    } else {
                        echo json_encode(['message' => 'C√≥ l·ªói khi t·∫£i ·∫£nh l√™n.']);
                        exit;
                    }
                }
            }
        }

        $font_size = "16px";
        $color_note = "#ffffff";

        // Ch√®n d·ªØ li·ªáu v√†o database
        $stmt = $pdo->prepare("
            INSERT INTO notes (user_id, title, content, created_at, modified_at, is_pinned, category, tags, password, image, font_size, note_color)
            VALUES (?, ?, ?, NOW(), NOW(), ?, ?, ?, ?, ?, ?, ?)
        ");

        // Chuy·ªÉn m·∫£ng ƒë∆∞·ªùng d·∫´n ·∫£nh th√†nh JSON
        $imageJson = json_encode($imagePaths);

        if ($stmt->execute([
            $_SESSION['user_id'], 
            $title, 
            $content, 
            $is_pinned, 
            $category, 
            implode(',', $tagsArray), // S·ª≠ d·ª•ng chu·ªói tags
            $password, 
            $imageJson,
            $font_size,
            $color_note
        ])) {
            // L·∫•y id c·ªßa ghi ch√∫ v·ª´a t·∫°o
            $note_id = $pdo->lastInsertId();
             // Ghi v√†o b·∫£ng l·ªãch s·ª≠
            $historyStmt = $pdo->prepare("
                INSERT INTO note_history (note_id, user_id, action)
                VALUES (?, ?, ?)
            ");
            $historyStmt->execute([$note_id, $_SESSION['user_id'], 'ƒê√£ t·∫°o m·ªõi ghi ch√∫.']);

            // Th√™m c√°c nh√£n v√†o b·∫£ng note_tags
            foreach ($tagsArray as $tag) {
                $tag = trim($tag); // X√≥a kho·∫£ng tr·∫Øng

                // Ki·ªÉm tra xem nh√£n ƒë√£ t·ªìn t·∫°i hay ch∆∞a
                $stmt = $pdo->prepare("SELECT id FROM tags WHERE name = ? AND user_id = ?");
                $stmt->execute([$tag, $_SESSION['user_id']]);
                $tag_id = $stmt->fetchColumn();

                if ($tag_id) {
                    // Ch√®n v√†o b·∫£ng note_tags
                    $stmt = $pdo->prepare("INSERT INTO note_tags (note_id, tag_id) VALUES (?, ?)");
                    $stmt->execute([$note_id, $tag_id]);
                } else {
                    // N·∫øu nh√£n kh√¥ng t·ªìn t·∫°i, b·∫°n c√≥ th·ªÉ mu·ªën t·∫°o nh√£n m·ªõi
                    $stmt = $pdo->prepare("INSERT INTO tags (name, user_id) VALUES (?, ?)");
                    $stmt->execute([$tag, $_SESSION['user_id']]);
                    $tag_id = $pdo->lastInsertId(); // L·∫•y id c·ªßa nh√£n m·ªõi

                    // Ch√®n v√†o b·∫£ng note_tags
                    $stmt = $pdo->prepare("INSERT INTO note_tags (note_id, tag_id) VALUES (?, ?)");
                    $stmt->execute([$note_id, $tag_id]);
                }
            }

            http_response_code(201);
            echo json_encode([
                'message' => 'Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng.',
                'images' => $imagePaths
            ]);
        } else {
            error_log("L·ªñI SQL: " . print_r($stmt->errorInfo(), true));
            http_response_code(500);
            echo json_encode(['message' => 'L·ªói khi l∆∞u ghi ch√∫.']);
            
        }
        exit;
    }
        
        // **Thay ƒë·ªïi m·∫≠t kh·∫©u ghi ch√∫ (PUT)**
    if ($_SERVER['REQUEST_METHOD'] === 'PUT' && isset($_GET['action']) && $_GET['action'] === 'change_password') {
        $data = json_decode(file_get_contents("php://input"), true);
        $note_id = $data['note_id'] ?? '';
        $current_password = $data['current_password'] ?? '';
        $new_password = $data['new_password'] ?? '';

        if (!empty($note_id) && !empty($new_password)) {
            // Ki·ªÉm tra m·∫≠t kh·∫©u hi·ªán t·∫°i
            $stmt = $pdo->prepare("SELECT password FROM notes WHERE id = ? AND user_id = ?");
            $stmt->execute([$note_id, $_SESSION['user_id']]);
            $note = $stmt->fetch(PDO::FETCH_ASSOC);

            $historyStmt = $pdo->prepare("
            INSERT INTO note_history (note_id, user_id, action)
            VALUES (?, ?, ?)
            ");
            $action_message = 'ƒê√£ thay ƒë·ªïi m·∫≠t kh·∫©u ghi ch√∫ c√° nh√¢n ' . $note_id;

            // Ghi v√†o b·∫£ng l·ªãch s·ª≠
            $historyStmt->execute([$note_id, $_SESSION['user_id'], $action_message]);

            if ($note) {
                if ($note['password'] === $current_password ||  $current_password === "") {
                    // C·∫≠p nh·∫≠t m·∫≠t kh·∫©u m·ªõi
                    $stmt = $pdo->prepare("UPDATE notes SET password = ? WHERE id = ? AND user_id = ?");
                    $stmt->execute([$new_password, $note_id, $_SESSION['user_id']]);
                                // Ghi v√†o b·∫£ng l·ªãch s·ª≠
                    $historyStmt = $pdo->prepare("
                        INSERT INTO note_history (note_id, user_id, action)
                        VALUES (?, ?, ?)
                    ");
                    $historyStmt->execute([$note_id, $_SESSION['user_id'], 'ƒê√£ thay ƒë·ªïi m·∫≠t kh·∫©u ghi ch√∫ '.$note_id]);

                    echo json_encode(['message' => 'M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi.']);
                } else {
                    
                    echo json_encode(['message' => 'M·∫≠t kh·∫©u hi·ªán t·∫°i kh√¥ng ƒë√∫ng.']);
                }
            } else {
                echo json_encode(['message' => 'Ghi ch√∫ kh√¥ng t√¨m th·∫•y.']);
            }
        } else {
            echo json_encode(['message' => 'Th√¥ng tin kh√¥ng ƒë·∫ßy ƒë·ªß.']);
        }
        exit;
    }

      // **T·∫Øt b·∫£o v·ªá b·∫±ng m·∫≠t kh·∫©u (DELETE)**
      if ($_SERVER['REQUEST_METHOD'] === 'PUT' && isset($_GET['action']) && $_GET['action'] === 'disable_password') {
        $data = json_decode(file_get_contents("php://input"), true);
        $note_id = $data['note_id'] ?? '';
        $user_id = $_SESSION['user_id'];

        if (!empty($note_id)) {
            $stmt = $pdo->prepare("UPDATE notes SET password = NULL WHERE id = ? AND user_id = ?");
            // $stmt->execute([$note_id, $_SESSION['user_id']]);
            $stmt->execute([$note_id,  $user_id ]);
            
            $historyStmt = $pdo->prepare("
            INSERT INTO note_history (note_id, user_id, action)
            VALUES (?, ?, ?)
            ");
            // $historyStmt->execute([$note_id, $_SESSION['user_id'], 'B·∫£o v·ªá b·∫±ng m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c t·∫Øt.']);
            $historyStmt->execute([$note_id,  $user_id , 'B·∫£o v·ªá b·∫±ng m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c t·∫Øt.']);

            echo json_encode(['message' => 'B·∫£o v·ªá b·∫±ng m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c t·∫Øt.']);
        } else {
            echo json_encode(['message' => 'Th√¥ng tin kh√¥ng ƒë·∫ßy ƒë·ªß.']);
        }
        exit;
    }

    if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['action'])) {
        $action = $_GET['action'];
    
        // **Xem ghi ch√∫ c√° nh√¢n (GET)**
        if ($action === 'view_note') {
            // $note_id_encode = $_GET['note_id'];
            // $note_id = decodeNumber($note_id_encode,$key);

            $note_id = $_GET['note_id'];
            $input_password = $_GET['password'] ?? null;
            $user_id = $_SESSION['user_id']  ?? 18;
    
            if (empty($note_id)) {
                echo json_encode(['error' => true, 'message' => '‚ùå Thi·∫øu th√¥ng tin note_id.']);
                exit;
            }
    
            // Truy v·∫•n ghi ch√∫ c·ªßa ng∆∞·ªùi d√πng
            $stmt = $pdo->prepare("SELECT * FROM notes WHERE id = ? AND user_id = ? ORDER BY is_pinned DESC, GREATEST(modified_at, created_at) DESC");
            $stmt->execute([$note_id, $user_id]);
            $note = $stmt->fetch(PDO::FETCH_ASSOC);
    
            if ($note) {
                // Ki·ªÉm tra m·∫≠t kh·∫©u (n·∫øu c√≥)
                if (empty($note['password']) || $note['password'] === $input_password) {
                    echo json_encode(['success' => true, 'message' => '‚úÖ Truy c·∫≠p th√†nh c√¥ng.', 'note' => $note]);
                } else {
                    echo json_encode(['error' => true, 'message' => '‚ùå M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.']);
                }
    
            } else {
                echo json_encode(['error' => true, 'message' => '‚ùå Ghi ch√∫ kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng thu·ªôc quy·ªÅn truy c·∫≠p.']);
            }
            exit;
        }
    
        // **Xem ghi ch√∫ ƒë∆∞·ª£c chia s·∫ª (GET)**
        if ($action === 'view_shared_note') {
            $note_id = $_GET['note_id'] ?? '';
            $input_password = $_GET['password'] ?? null;
    
            if (empty($note_id)) {
                echo json_encode(['error' => true, 'message' => '‚ùå Thi·∫øu th√¥ng tin note_id.']);
                exit;
            }
    
            // Truy v·∫•n quy·ªÅn truy c·∫≠p t·ª´ b·∫£ng `shared_notes`
            $stmt = $pdo->prepare("SELECT * FROM shared_notes WHERE note_id = ? AND password = ?");
            $stmt->execute([$note_id, $input_password]);
            $shared_note = $stmt->fetch(PDO::FETCH_ASSOC);
    
            if ($shared_note) {
                // L·∫•y th√¥ng tin ghi ch√∫ t·ª´ b·∫£ng `notes`
                $stmt = $pdo->prepare("SELECT * FROM notes WHERE id = ?");
                $stmt->execute([$note_id]);
                $note = $stmt->fetch(PDO::FETCH_ASSOC);
    
                if ($note) {
                    $note_data = [
                        'id' => $note['id'],
                        'title' => $note['title'],
                        'content' => $note['content'],
                        'created_at' => $note['created_at'],
                        'modified_at' => $note['modified_at'],
                        'user_id' => $note['user_id'],
                        'is_pinned' => $note['is_pinned'],
                        'category' => $note['category'],
                        'tags' => $note['tags'],
                        'permission' => $shared_note['permission'],
                        'image' => json_decode($note['image'], true), // Chuy·ªÉn JSON sang m·∫£ng PHP
                        'can_edit' => ($shared_note['permission'] === 'edit')
                    ];
    
                    echo json_encode(['success' => true, 'message' => '‚úÖ Truy c·∫≠p th√†nh c√¥ng.', 'note' => $note_data]);
                } else {
                    echo json_encode(['error' => true, 'message' => '‚ùå Ghi ch√∫ kh√¥ng t·ªìn t·∫°i.']);
                }
            } else {
                echo json_encode(['error' => true, 'message' => '‚ùå Ghi ch√∫ kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng thu·ªôc quy·ªÅn truy c·∫≠p.']);
            }
            exit;
        }
    
        // **Xem t·∫•t c·∫£ ghi ch√∫ c√° nh√¢n (GET)**
        if ($action === 'view_notes') {
            if (!empty($_SESSION['user_id'])) {
                $stmt = $pdo->prepare("SELECT * FROM notes WHERE user_id = ? ORDER BY is_pinned DESC, GREATEST(modified_at, created_at) DESC");
                $stmt->execute([$_SESSION['user_id']]);
                $notes = $stmt->fetchAll(PDO::FETCH_ASSOC);
                echo json_encode(['success' => true, 'notes' => $notes]);
            } else {
                echo json_encode(['error' => true, 'message' => '‚ùå Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p.']);
            }
            exit;
        }

         // **Xem t·∫•t c·∫£ ghi ch√∫ c√° nh√¢n (GET)**
         if ($action === 'get_note_history') {
            // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
            if (isset($_SESSION['user_id'])) {
                $user_id = $_SESSION['user_id'];

                // Truy v·∫•n l·∫•y l·ªãch s·ª≠ ghi ch√∫ c·ªßa ng∆∞·ªùi d√πng k√®m theo t√™n hi·ªÉn th·ªã
                $stmt = $pdo->prepare("
                    SELECT nh.id, nh.note_id, nh.user_id, nh.action, nh.timestamp, u.display_name 
                    FROM note_history nh 
                    JOIN users u ON nh.user_id = u.id 
                    WHERE nh.user_id = ? 
                    ORDER BY nh.timestamp DESC
                ");
                
                $stmt->execute([$user_id]);
                
                $history = $stmt->fetchAll(PDO::FETCH_ASSOC);

                // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu kh√¥ng
                if ($history) {
                    echo json_encode(['history' => $history]);
                } else {
                    echo json_encode(['message' => 'Kh√¥ng c√≥ d·ªØ li·ªáu l·ªãch s·ª≠.']);
                }
            } else {
                echo json_encode(['message' => 'Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p.']);
            }
            exit;
        }

        if ($action === 'get_note_history_by_id') {
            // Ki·ªÉm tra xem ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
            if (isset($_SESSION['user_id'])) {
                $user_id = $_SESSION['user_id'];
                $note_id = $_GET['note_id'];
                // Truy v·∫•n l·∫•y l·ªãch s·ª≠ ghi ch√∫ theo ID ghi ch√∫
                $stmt = $pdo->prepare("
                    SELECT nh.id, nh.note_id, nh.user_id, nh.action, nh.timestamp, u.display_name 
                    FROM note_history nh 
                    JOIN users u ON nh.user_id = u.id 
                    WHERE nh.note_id = ? 
                    ORDER BY nh.timestamp DESC
                ");
                
                $stmt->execute([$note_id]);
                
                $history = $stmt->fetchAll(PDO::FETCH_ASSOC);

                // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu kh√¥ng
                if ($history) {
                    echo json_encode(['history' => $history]);
                } else {
                    echo json_encode(['message' => 'Kh√¥ng c√≥ d·ªØ li·ªáu l·ªãch s·ª≠ cho ghi ch√∫ n√†y.']);
                }
            } else {
                echo json_encode(['message' => 'Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p.']);
            }
            exit;
        }

        
    }
    
    // N·∫øu kh√¥ng c√≥ action h·ª£p l·ªá
    echo json_encode(['error' => true, 'message' => '‚ö† H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá.']);
    exit;
  

} catch (PDOException $e) {
    http_response_code(500);
    echo json_encode(['message' => 'L·ªói khi l∆∞u d·ªØ li·ªáu: ' . htmlspecialchars($e->getMessage())]);
}
?>