<?php
require 'config.php'; // K·∫øt n·ªëi t·ªõi c∆° s·ªü d·ªØ li·ªáu
require 'send_email.php'; // Nh√∫ng t·ªáp g·ª≠i email
session_start();


// üî• Th√™m header ƒë·ªÉ b·∫≠t CORS
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: GET, POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type");

// Tr·∫£ v·ªÅ JSON
header('Content-Type: application/json');


$key = "12345";
// H√†m t·∫°o m·∫≠t kh·∫©u ng·∫´u nhi√™n
function generateRandomPassword($length = 10) {
    return bin2hex(random_bytes($length / 2));
}

function encodeNumber($number, $key) {
    $hash = hash_hmac('sha256', $number, $key, true);
    $encoded = base64_encode($number . '::' . $hash);
    return str_replace(['+', '/', '='], ['-', '_', ''], $encoded); // Chuy·ªÉn ƒë·ªïi base64 th√†nh URL-safe base64
}

// Ki·ªÉm tra ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
if (!isset($_SESSION['user_id'])) {
    echo json_encode(['message' => 'Ch∆∞a ƒëƒÉng nh·∫≠p.']);
    exit;
}

// Chia s·∫ª ghi ch√∫
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_GET['action']) && $_GET['action'] === 'share_note') {
    $data = json_decode(file_get_contents("php://input"), true);

    if (isset($data['note_id']) && isset($data['recipients']) && isset($data['permission'])) {
        $note_id = $data['note_id'];
        $recipients = $data['recipients']; // ƒê√¢y l√† m·ªôt m·∫£ng email
        $permission = $data['permission'];
        $shared_by = $_SESSION['user_id']; // ID c·ªßa ng∆∞·ªùi chia s·∫ª
        $email_send = $_SESSION['user_email']; // ID c·ªßa ng∆∞·ªùi chia s·∫ª

        $responses = []; // M·∫£ng ƒë·ªÉ l∆∞u tr·ªØ ph·∫£n h·ªìi cho t·ª´ng email

        foreach ($recipients as $recipient_email) {
            if (!filter_var($recipient_email, FILTER_VALIDATE_EMAIL)) {
                $responses[] = ['email' => $recipient_email, 'message' => 'Email kh√¥ng h·ª£p l·ªá.'];
                continue;
            }

            // Check if the note has already been shared with this recipient
            $checkStmt = $pdo->prepare("
                SELECT * FROM shared_notes WHERE note_id = ? AND recipient_email = ?
            ");
            $checkStmt->execute([$note_id, $recipient_email]);

            if ($checkStmt->rowCount() > 0) {
                $responses[] = ['email' => $recipient_email, 'message' => 'Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c chia s·∫ª v·ªõi b·∫°n tr∆∞·ªõc ƒë√≥.'];
                continue; // Skip to the next recipient
            }

            $access_password = generateRandomPassword();
            $stmt = $pdo->prepare("
                INSERT INTO shared_notes (note_id, recipient_email, permission, access_password, shared_by, created_at)
                VALUES (?, ?, ?, ?, ?, NOW())
            ");
            
            if ($stmt->execute([$note_id, $recipient_email, $permission, $access_password, $shared_by])) {
                $token = encodeNumber($note_id, $key);
                // Prepare email content
                $note_link = "http://localhost/note_management/api/share_note?note_id=" . $token;
                // T·∫°o URL cho API
                $url = 'https://api.qrserver.com/v1/create-qr-code/?data=' . urlencode($note_link) . '&size=200x200';
                $subject = "A note has been shared with you - $email_send";
                $body = <<<EOD
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Email Share Note</title>
                </head>
                <body style='margin-top:20px;'>
                    <table class='body-wrap' style='font-family: "Helvetica Neue",Helvetica,Arial,sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; background-color: #f6f6f6; margin: 0;' bgcolor='#f6f6f6'>
                        <tbody>
                            <tr>
                                <td valign='top'></td>
                                <td class='container' width='600' valign='top'>
                                    <div class='content' style='padding: 20px;'>
                                        <table class='main' width='100%' cellpadding='0' cellspacing='0' style='border-radius: 3px; background-color: #fff; margin: 0; border: 1px solid #e9e9e9;' bgcolor='#fff'>
                                            <tbody>
                                                <tr>
                                                    <td class='' style='font-size: 16px; vertical-align: top; color: #fff; font-weight: 500; text-align: center; background-color: #38414a; padding: 20px;' align='center' bgcolor='#71b6f9' valign='top'>
                                                        <a href='#' style='font-size:32px;color:#fff;text-decoration: none;'>Hello, $recipient_email!</a> <br>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class='content-wrap' style='padding: 20px;' valign='top'>
                                                        <table width='100%' cellpadding='0' cellspacing='0'>
                                                            <tbody>
                                                                <tr>
                                                                    <td class='content-block' style='padding: 0 0 20px;' valign='top'>
                                                                        You have been invited to a Share Note project.
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class='content-block' style='padding: 0 0 20px;' valign='top'>
                                                                        You have been granted shared access with $permission permissions. You can use a QR code to access the shared note link.
                                                                    </td>
                                                                </tr>

                                                                <tr>
                                                                    <td class='content-block' style='padding: 0 0 20px; text-align: center;' valign='top'>
                                                                        <img src="$url" alt="M√£ QR">
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class='content-block' style='text-align: center;' valign='top'>
                                                                        <a class='btn-primary' style='font-size: 14px; color: #FFF; text-decoration: none; line-height: 2em; font-weight: bold; border-radius: 5px; background-color: #D10024; padding: 8px 16px; display: inline-block;'>$access_password</a>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class='content-block' style='padding: 0 0 20px;' valign='top'>
                                                                        If you cannot view this QR code, please copy and paste this link into your browser's address bar.
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class='content-block' style='padding: 0 0 20px;' valign='top'>
                                                                        <a href="$note_link">$note_link</a> 
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class='content-block' style='padding: 0 0 20px;' valign='top'>
                                                                        See you there!
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class='content-block' style='padding: 0 0 20px;' valign='top'>
                                                                        Best regards, the Note Website team.
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                                <td valign='top'></td>
                            </tr>
                        </tbody>
                    </table>
                </body>
                </html>
                EOD;

                if (sendEmail($recipient_email, $subject, $body)) {
                    // Ghi v√†o b·∫£ng l·ªãch s·ª≠
                    $historyStmt = $pdo->prepare("
                        INSERT INTO note_history (note_id, user_id, action)
                        VALUES (?, ?, ?)
                    ");
                    $action_message = 'ƒê√£ chia s·∫ª ghi ch√∫ v·ªõi ' . $recipient_email;

                    $historyStmt->execute([$note_id, $_SESSION['user_id'], $action_message]);

                    $responses[] = ['email' => $recipient_email, 'message' => 'Email ƒë√£ ƒë∆∞·ª£c g·ª≠i.'];
                } else {
                    $responses[] = ['email' => $recipient_email, 'message' => 'Ghi ch√∫ ƒë√£ ƒë∆∞·ª£c chia s·∫ª nh∆∞ng kh√¥ng th·ªÉ g·ª≠i email.'];
                }
            } else {
                $responses[] = ['email' => $recipient_email, 'message' => 'Chia s·∫ª ghi ch√∫ kh√¥ng th√†nh c√¥ng.'];
            }
        }

        echo json_encode($responses);
    } else {
        echo json_encode(['message' => 'Vui l√≤ng cung c·∫•p note_id, recipients v√† permission.']);
    }
}

// H√†m ƒë·ªÉ l·∫•y ghi ch√∫ ƒë√£ chia s·∫ª c√πng v·ªõi th√¥ng tin ch·ªß s·ªü h·ªØu
function getSharedNotes($pdo, $user_email) {
    $stmt = $pdo->prepare("
        SELECT sn.id, sn.note_id, n.title, sn.recipient_email, sn.permission, sn.access_password, 
               u.display_name AS shared_by, u2.display_name AS owner, sn.created_at
        FROM shared_notes sn
        JOIN notes n ON sn.note_id = n.id
        JOIN users u ON sn.shared_by = u.id
        JOIN users u2 ON n.user_id = u2.id  
        WHERE sn.recipient_email = ?
    ");
    $stmt->execute([$user_email]);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

// H√†m ƒë·ªÉ l·∫•y ghi ch√∫ ƒë√£ chia s·∫ª c√πng v·ªõi th√¥ng tin ch·ªß s·ªü h·ªØu
function getSharedNotesWithOwner($pdo, $user_id) {
    $stmt = $pdo->prepare("
        SELECT sn.id, sn.note_id, n.title, sn.recipient_email, sn.permission, sn.access_password, 
               u.display_name AS shared_by, u2.display_name AS owner, sn.created_at
        FROM shared_notes sn
        JOIN notes n ON sn.note_id = n.id
        JOIN users u ON sn.shared_by = u.id
        JOIN users u2 ON n.user_id = u2.id  
        WHERE sn.shared_by = ?
    ");
    $stmt->execute([$user_id]);
    return $stmt->fetchAll(PDO::FETCH_ASSOC);
}

// Ki·ªÉm tra ph∆∞∆°ng th·ª©c GET ƒë·ªÉ l·∫•y ghi ch√∫ ƒë√£ chia s·∫ª c√πng v·ªõi th√¥ng tin ch·ªß s·ªü h·ªØu
if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['action']) && $_GET['action'] === 'get_shared_notes_other') {
    $user_email = $_SESSION['user_email']; 
    $shared_notes = getSharedNotes($pdo, $user_email);
    echo json_encode($shared_notes);
    exit;
}


// Ki·ªÉm tra ph∆∞∆°ng th·ª©c GET ƒë·ªÉ l·∫•y ghi ch√∫ ƒë√£ chia s·∫ª c√πng v·ªõi th√¥ng tin ch·ªß s·ªü h·ªØu
if ($_SERVER['REQUEST_METHOD'] === 'GET' && isset($_GET['action']) && $_GET['action'] === 'get_shared_notes_owner') {
    $user_id = $_SESSION['user_id']; 
    $shared_notes = getSharedNotesWithOwner($pdo, $user_id);
    echo json_encode($shared_notes);
    exit;
}

// S·ª≠a ghi ch√∫ ƒë√£ chia s·∫ª
if ($_SERVER['REQUEST_METHOD'] === 'PUT' && isset($_GET['action']) && $_GET['action'] === 'edit_shared_note') {
    $data = json_decode(file_get_contents("php://input"), true);
    
    // Ki·ªÉm tra c√°c tham s·ªë c·∫ßn thi·∫øt
    if (isset($data['shared_note_id'], $data['id'], $data['permission'])) {
        $note_id = $data['shared_note_id'];
        $id_share = $data['id'];
        $new_permission = $data['permission'];

        // C·∫≠p nh·∫≠t quy·ªÅn truy c·∫≠p ghi ch√∫
        $stmt = $pdo->prepare("UPDATE shared_notes SET permission = ? WHERE id = ? AND note_id = ?");
        $historyStmt = $pdo->prepare("
            INSERT INTO note_history (note_id, user_id, action)
            VALUES (?, ?, ?)
        ");

        // Ghi l·∫°i h√†nh ƒë·ªông ch·ªânh s·ª≠a quy·ªÅn
        $action_message = 'ƒê√£ ch·ªânh s·ª≠a quy·ªÅn truy c·∫≠p ghi ch√∫ th√†nh ' . $new_permission;

        if ($stmt->execute([$new_permission, $id_share, $note_id]) && $historyStmt->execute([$note_id, $_SESSION['user_id'], $action_message])) {
            echo json_encode(['message' => 'C·∫≠p nh·∫≠t th√†nh c√¥ng.']);
        } else {
            echo json_encode(['message' => 'C·∫≠p nh·∫≠t kh√¥ng th√†nh c√¥ng.']);
        }
    } else {
        echo json_encode(['message' => 'Thi·∫øu tham s·ªë c·∫ßn thi·∫øt.']);
    }
    exit;
}
// X√≥a ghi ch√∫ ƒë√£ chia s·∫ª
if ($_SERVER['REQUEST_METHOD'] === 'DELETE' && isset($_GET['action']) && $_GET['action'] === 'delete_shared_note') {
    $data = json_decode(file_get_contents("php://input"), true);
    
    // Ki·ªÉm tra c√°c tham s·ªë c·∫ßn thi·∫øt
    if (isset($data['shared_note_id'], $data['id'])) {
        $note_id = $data['id'];
        $id_share = $data['shared_note_id'];

        // C√¢u l·ªánh x√≥a ghi ch√∫ chia s·∫ª
        $stmt = $pdo->prepare("DELETE FROM shared_notes WHERE id = ? AND note_id = ?");
        
        // Th·ª±c hi·ªán x√≥a
        if ($stmt->execute([$note_id,$id_share])) {
            // Ghi v√†o b·∫£ng l·ªãch s·ª≠ ch·ªâ sau khi x√≥a th√†nh c√¥ng
            $historyStmt = $pdo->prepare("
                INSERT INTO note_history (note_id, user_id, action)
                VALUES (?, ?, ?)
            ");
            $action_message = 'ƒê√£ thu h·ªìi quy·ªÅn chia s·∫ª ghi ch√∫ ' . $id_share;

            // Ghi v√†o b·∫£ng l·ªãch s·ª≠
            $historyStmt->execute([$note_id, $_SESSION['user_id'], $action_message]);

            echo json_encode(['message' => 'ƒê√£ thu h·ªìi quy·ªÅn chia s·∫ª ghi ch√∫ th√†nh c√¥ng.']);
        } else {
            echo json_encode(['message' => 'Thu h·ªìi quy·ªÅn chia s·∫ª ghi ch√∫ kh√¥ng th√†nh c√¥ng.']);
        }
    } else {
        echo json_encode(['message' => 'Thi·∫øu tham s·ªë c·∫ßn thi·∫øt.']);
    }
    exit;
}
?>